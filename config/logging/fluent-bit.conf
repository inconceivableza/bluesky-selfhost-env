[SERVICE]
    Flush        5
    Daemon       Off
    Log_Level    info
    Parsers_File parsers.conf
    storage.path              /var/log/flb-storage/
    storage.sync              normal
    storage.checksum          off
    storage.max_chunks_up     128
    storage.backlog.mem_limit 5M

[INPUT]
    Name              tail
    Path              /var/lib/docker/containers/*/*.log
    Parser            docker
    Tag               docker.*
    Docker_Mode       On
    Refresh_Interval  5
    storage.type      filesystem
    Mem_Buf_Limit     5MB

[FILTER]
    Name                parser
    Match               docker.*
    Key_Name            log
    Parser              json
    Reserve_Data        On
    Preserve_Key        On

# Add container metadata using Lua script
[FILTER]
    Name   lua
    Match  docker.*
    script /fluent-bit/etc/add-container-metadata.lua
    call   add_container_metadata

# Exclude Fluent Bit's own logs to avoid feedback loop
# [FILTER]
#     Name    grep
#     Match   docker.*
#     Exclude log ^\[.*\]\s+\[\s*(info|warn)\s*\]\s+\[engine\]

[OUTPUT]
    Name                opensearch
    Match               docker.*
    Host                ${OPENSEARCH_HOST}
    Port                ${OPENSEARCH_PORT}
    Index               logs
    Logstash_Format     On
    Logstash_Prefix     logs
    Logstash_DateFormat %Y.%m.%d
    Suppress_Type_Name  On
    Retry_Limit         3
    Buffer_Size         False
    Trace_Output        Off
    Trace_Error         On