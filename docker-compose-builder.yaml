volumes:
  caddy-data:
    name: caddy-data
    #   driver: local
    #   driver_opts:
    #     o: bind
    #     device: ${dDir}/caddy
    #     type: none
  caddy-config:
    name: caddy-config
  database:
    name: database
  opensearch:
    name: opensearch
  bgs:
    name: bgs
  bsky:
    name: bsky
  feed-generator:
    name: feed-generator
  pds:
    name: pds
  redis:
    name: redis
  jetstream:
    name: jetstream
  backup-staging:
    name: backup-staging
  backup-repo:
    name: backup-repo
  ipcc:
    name: ipcc
# ozone:
# ozone-daemon:
# plc:
# palomar:
# social-app:

networks:
 default:
    name: ${docker_network}
    external: true

services:
  caddy:
    #   reverse proxy
    #   cf. https://blog.kurokobo.com/archives/3669#Caddy_acme_server
    image: ${BRANDED_NAMESPACE}/caddy:2
    build:
      context: .
      dockerfile: ops/caddy-Dockerfile
      args:
        CADDY_DNS_PACKAGE_SRC: ${CADDY_DNS_PACKAGE_SRC}
    ports:
      - 80:80
      - 443:443
      - 443:443/udp
      # - 9000:9000 # internal CA server; doesn't need to be public
    environment:
      - GOINSECURE=${GOINSECURE}
      - NODE_TLS_REJECT_UNAUTHORIZED=${NODE_TLS_REJECT_UNAUTHORIZED}
      - DOMAIN=${DOMAIN}
      - socialappFQDN=${socialappFQDN}
      - pdsFQDN=${pdsFQDN}
      - EMAIL4CERTS=${EMAIL4CERTS}
      - BSKY_ADMIN_PASSWORDS=${BSKY_ADMIN_PASSWORDS}
      - bgsFQDN=${bgsFQDN}
      - bskyFQDN=${bskyFQDN}
      - feedgenFQDN=${feedgenFQDN}
      - jetstreamFQDN=${jetstreamFQDN}
      - ozoneFQDN=${ozoneFQDN}
      - palomarFQDN=${palomarFQDN}
      - pdsFQDN=${pdsFQDN}
      - plcFQDN=${plcFQDN}
      - publicApiFQDN=${publicApiFQDN}
      - socialappFQDN=${socialappFQDN}
      - CADDY_DNS_PROVIDER=${CADDY_DNS_PROVIDER}
      - CADDY_DNS_API_TOKEN=${CADDY_DNS_API_TOKEN}
      - CADDY_DNS_RESOLVER=${CADDY_DNS_RESOLVER}
      - CADDY_DNS_USED=${CADDY_DNS_USED}
      - OTEL_EXPORTER_OTLP_TRACES_ENDPOINT=http://otel-collector:4317
      - OTEL_SERVICE_NAME=caddy
    volumes:
      - ./config/caddy/Caddyfile:/etc/caddy/Caddyfile
      # CA certificates for self-signed. >>>
      - ./certs/root.crt:/data/caddy/pki/authorities/local/root.crt:ro
      - ./certs/root.key:/data/caddy/pki/authorities/local/root.key:ro
      # CA certificates for self-signed. <<<
      - caddy-data:/data
      - caddy-config:/config
      # the social app's static website
      - ./${PDS_WEB_DIR:-staticweb}:/socialweb
    healthcheck:
      # https://caddy.community/t/what-is-the-best-practise-for-doing-a-health-check-for-caddy-containers/12995
      test: "wget --no-verbose --tries=1 --spider http://localhost:2019/metrics || exit 1"
      interval: 5s
      retries: 20
    restart: always

# to generate HTTPS certifications on-demand >>>>>
  caddy-sidecar:
    image: httpd:2
    environment:
      - GOINSECURE=${GOINSECURE}
      - NODE_TLS_REJECT_UNAUTHORIZED=${NODE_TLS_REJECT_UNAUTHORIZED}
    volumes:
      - ./certs/ca-certificates.crt:/etc/ssl/certs/ca-certificates.crt:ro
# to generate HTTPS certifications on-demand <<<<<

# debug for caddy>>> 
  test-wss:
    image: itaru2622/fastapi:bookworm
    environment:
      - app=main:app
      - opts=--host 0.0.0.0 --port 8080
    working_dir: /opt/fastapi-samples/3catchall

  test-ws:
    image: itaru2622/fastapi:bookworm
    environment:
      - app=main:app
      - opts=--host 0.0.0.0 --port 8080
    working_dir: /opt/fastapi-samples/3catchall

# debug for caddy <<<
# debug for bluesky with indigo subcmds >>>
  test-indigo:
    image: ${UNBRANDED_NAMESPACE}/bluesky-indigo-tools:${asof}
    profiles: ['', 'indigo']
    build:
       context: ./repos/indigo/
       dockerfile: Dockerfile
       args:
       - http_proxy=${http_proxy}
       - https_proxy=${https_proxy}
       - no_proxy=${no_proxy}
       - JAVA_TOOL_OPTIONS=${JAVA_TOOL_OPTIONS}
    command: tail -f /dev/null
    environment:
      - ATP_PLC_HOST=https://${plcFQDN}
      - BGS_ADMIN_KEY=${BGS_ADMIN_KEY}
      - CARSTORE_DATABASE_URL=postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@database/carstore
      - DATABASE_URL=postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@database/bgs
      - DATA_DIR=/data/bigsky
      - DEBUG_MODE=1
      - GOINSECURE=${GOINSECURE}
      - GOLOG_LOG_LEVEL=${LOG_LEVEL_DEFAULT}
      - LOG_DESTINATION=1
      - LOG_ENABLED=true
      - LOG_LEVEL=${LOG_LEVEL_DEFAULT}
      - NODE_ENV=development
      - NODE_TLS_REJECT_UNAUTHORIZED=${NODE_TLS_REJECT_UNAUTHORIZED}
    volumes:
      - ./certs/ca-certificates.crt:/etc/ssl/certs/ca-certificates.crt:ro

# debug for bluesky with indigo subcmds <<<

  database:
    image: postgres:16-bookworm
    ports:
      - 5432:5432
    environment:
      - GOINSECURE=${GOINSECURE}
      - NODE_TLS_REJECT_UNAUTHORIZED=${NODE_TLS_REJECT_UNAUTHORIZED}
      - POSTGRES_INITDB_ARGS=--encoding=UTF-8 --lc-collate=C --lc-ctype=C
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=healthcheck
    volumes:
      - ./config/init-postgres:/docker-entrypoint-initdb.d/
      - database:/var/lib/postgresql/data/
    restart: always

  pgadmin:
    image: dpage/pgadmin4
    ports:
      - 54321:80
    environment:
      - PGADMIN_DEFAULT_EMAIL=example@example.com
      - PGADMIN_DEFAULT_PASSWORD=password
      #   volumes:
      #      - ./certs/ca-certificates.crt:/etc/ssl/certs/ca-certificates.crt:ro
    depends_on:
      - database

  redis:
    image: redis:7-bookworm
    volumes:
      - redis:/data/
    restart: always

  opensearch:
    image: ${UNBRANDED_NAMESPACE}/bluesky-indigo-opensearch:${asof}
    profiles: ['', 'indigo']
    build:
      context: ./repos/indigo/
      dockerfile: cmd/palomar/Dockerfile.opensearch
      args:
       - http_proxy=${http_proxy}
       - https_proxy=${https_proxy}
       - no_proxy=${no_proxy}
       - JAVA_TOOL_OPTIONS=${JAVA_TOOL_OPTIONS}
# cf. https://github.com/opensearch-project/OpenSearch/issues/8215
       - OPENSEARCH_JAVA_OPTS=${OPENSEARCH_JAVA_OPTS}
    ports:
      - 9200:9200
    environment:
      - GOINSECURE=${GOINSECURE}
      - NODE_TLS_REJECT_UNAUTHORIZED=${NODE_TLS_REJECT_UNAUTHORIZED}
      - OPENSEARCH_JAVA_OPTS=-Xms512m -Xmx512m
      - OPENSEARCH_INITIAL_ADMIN_PASSWORD=${OPENSEARCH_INITIAL_ADMIN_PASSWORD}
      - bootstrap.memory_lock=true
      - cluster.name=docker-cluster
      - discovery.type=single-node
      - http.host=0.0.0.0
      - node.name=os-node
      - plugins.security.disabled=true
      - transport.host=127.0.0.1
    ulimits:
      memlock:
        soft: -1
        hard: -1
    volumes:
      - opensearch:/usr/share/opensearch/data/
    restart: always

  plc:
#   image: ${UNBRANDED_NAMESPACE}/bluesky-did-method-plc:${asof}
    image: ${BRANDED_NAMESPACE}/${REBRANDING_NAME:-bluesky}-did-method-plc:${branded_asof}
    profiles: ['', 'did-method-plc']
    build:
      context: ./repos/did-method-plc/
      dockerfile: packages/server/Dockerfile
      args:
       - http_proxy=${http_proxy}
       - https_proxy=${https_proxy}
       - no_proxy=${no_proxy}
       - JAVA_TOOL_OPTIONS=${JAVA_TOOL_OPTIONS}
    ports:
      - 2582:2582
    volumes:
      # supporting self-signed certificates, easiest way >>>>
      - ./certs/ca-certificates.crt:/etc/ssl/certs/ca-certificates.crt:ro
      # supporting self-signed certificates, easiest way <<<<
    environment:
      - DATABASE_URL=postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@database/plc
      - DB_CREDS_JSON={"username":"${POSTGRES_USER}","password":"${POSTGRES_PASSWORD}","host":"database","port":"5432","database":"plc"}
      - DB_MIGRATE_CREDS_JSON={"username":"${POSTGRES_USER}","password":"${POSTGRES_PASSWORD}","host":"database","port":"5432","database":"plc"}
      - DEBUG_MODE=1
      - ENABLE_MIGRATIONS=true
      - GOINSECURE=${GOINSECURE}
      - LOG_DESTINATION=1
      - LOG_ENABLED=true
      - LOG_LEVEL=${LOG_LEVEL_DEFAULT}
      - NODE_ENV=development
      - NODE_TLS_REJECT_UNAUTHORIZED=${NODE_TLS_REJECT_UNAUTHORIZED}
      - PORT=2582
      # telemetry settings
      - DD_TRACE_AGENT_URL=http://otel-collector:8126
      - DD_TRACE_PROPAGATION_STYLE=tracecontext,baggage
      - DD_TRACE_128_BIT_TRACEID_LOGGING_ENABLED=true
    restart: always
    depends_on:
      - database
      - caddy

  pds:
    # image: ${UNBRANDED_NAMESPACE}/bluesky-atproto-pds:${asof}
    image: ${BRANDED_NAMESPACE}/${REBRANDING_NAME:-bluesky}-atproto-pds:${branded_asof}
    profiles: ['', 'atproto']
    build:
      context: ./repos/atproto/
      dockerfile: services/pds/Dockerfile
      args:
       - http_proxy=${http_proxy}
       - https_proxy=${https_proxy}
       - no_proxy=${no_proxy}
       - JAVA_TOOL_OPTIONS=${JAVA_TOOL_OPTIONS}
    ports:
      - 2583:2583
    expose:
      - 2583
    # to fix permision mismatch between volume owner(root) and process user(uid:1000, i.e: node), run as root. >>>>
    user: root
    # to fix permision mismatch between volume owner(root) and process user(uid:1000, i.e: node), run as root. <<<<
    environment:
      - DEBUG_MODE=1
      - GOINSECURE=${GOINSECURE}
      - LOG_DESTINATION=1
      - LOG_ENABLED=true
      - LOG_LEVEL=${LOG_LEVEL_DEFAULT}
      - NODE_ENV=development
      - NODE_TLS_REJECT_UNAUTHORIZED=${NODE_TLS_REJECT_UNAUTHORIZED}
      - PDS_ADMIN_PASSWORD=${PDS_ADMIN_PASSWORD}
      - PDS_BLOBSTORE_DISK_LOCATION=/pds/blobs
      - PDS_BSKY_APP_VIEW_DID=did:web:${bskyFQDN}
      - PDS_BSKY_APP_VIEW_URL=https://${bskyFQDN}
      - PDS_CRAWLERS=https://${bgsFQDN}
      - PDS_DATA_DIRECTORY=/pds
      - PDS_DEV_MODE=true
#     - PDS_BLOBSTORE_DISK_TMP_LOCATION=/pds/image/tmp
      - PDS_DID_PLC_URL=https://${plcFQDN}
      - PDS_EMAIL_FROM_ADDRESS=${PDS_EMAIL_FROM_ADDRESS}
      - PDS_EMAIL_IMAGES_BASE_URL=${PDS_EMAIL_IMAGES_BASE_URL}
      - PDS_EMAIL_SMTP_URL=${PDS_EMAIL_SMTP_URL}
      - PDS_ENABLE_DID_DOC_WITH_SESSION=true
      - PDS_HOSTNAME=${pdsFQDN}
      - PDS_INVITE_INTERVAL=${PDS_INVITE_INTERVAL}
      - PDS_INVITE_REQUIRED=${PDS_INVITE_REQUIRED}
      - PDS_JWT_SECRET=${PDS_JWT_SECRET}
      - PDS_PLC_ROTATION_KEY_K256_PRIVATE_KEY_HEX=${PDS_PLC_ROTATION_KEY_K256_PRIVATE_KEY_HEX}
      - PDS_PORT=2583
# starts: unset optional env for tesing ozone >>>>>>>
#     - PDS_MOD_SERVICE_DID=did:web:${ozoneFQDN}
#     - PDS_MOD_SERVICE_URL=https://${ozoneFQDN}
#     - PDS_REPORT_SERVICE_DID=did:web:${ozoneFQDN}
#     - PDS_REPORT_SERVICE_URL=https://${ozoneFQDN}
# ends: unset optional env for tesing ozone <<<<<<<
      - PDS_SERVICE_DID=did:web:${pdsFQDN}
      - PDS_SOCIAL_APP_DESCRIPTION=${SOCIAL_APP_DESCRIPTION}
      - PDS_SOCIAL_APP_EMOJI=${SOCIAL_APP_EMOJI}
      - PDS_SOCIAL_APP_NAME=${SOCIAL_APP_NAME}
      - PDS_SOCIAL_APP_URL=${SOCIAL_APP_URL}
      # telemetry settings
      - DD_TRACE_AGENT_URL=http://otel-collector:8126
      - DD_TRACE_OTEL_ENABLED=true
      - DD_SERVICE=pds # the package.json misconfigures this as plc-service
      - DD_TRACE_PROPAGATION_STYLE=datadog,tracecontext,baggage
      - DD_TRACE_128_BIT_TRACEID_LOGGING_ENABLED=true
      - OTEL_PROPAGATORS=datadog,tracecontext,baggage
      - OTEL_EXPORTER_OTLP_INSECURE=true
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4318
    volumes:
      # supporting self-signed certificates, easiest way >>>>
      - ./certs/ca-certificates.crt:/etc/ssl/certs/ca-certificates.crt:ro
      # supporting self-signed certificates, easiest way <<<<
      - pds:/pds
    restart: always
    depends_on:
      - database
      - caddy

  bgs:
    image: ${BRANDED_NAMESPACE}/${REBRANDING_NAME:-bluesky}-indigo-bgs:${branded_asof}
    profiles: ['', 'indigo']
    build:
      context: ./repos/indigo/
      dockerfile: cmd/bigsky/Dockerfile
      args:
       - http_proxy=${http_proxy}
       - https_proxy=${https_proxy}
       - no_proxy=${no_proxy}
       - JAVA_TOOL_OPTIONS=${JAVA_TOOL_OPTIONS}
    ports:
      - 2470:2470
      - 2471:2471
    command: ['/bigsky', '--db-tracing']
    environment:
      - ATP_PLC_HOST=https://${plcFQDN}
      - BGS_ADMIN_KEY=${BGS_ADMIN_KEY}
      - CARSTORE_DATABASE_URL=postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@database/carstore
      - DATABASE_URL=postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@database/bgs
      - DATA_DIR=/data/bigsky
      - DEBUG_MODE=1
      - GOINSECURE=${GOINSECURE}
#     - GODEBUG=netdns=go+4
      - GOLOG_LOG_LEVEL=${LOG_LEVEL_DEFAULT}
      - LOG_DESTINATION=1
      - LOG_ENABLED=true
      - LOG_LEVEL=${LOG_LEVEL_DEFAULT}
      - NODE_ENV=development
      - NODE_TLS_REJECT_UNAUTHORIZED=${NODE_TLS_REJECT_UNAUTHORIZED}
      - RELAY_NEWPDS_PERDAY_LIMIT=10000
      - OTEL_EXPORTER_OTLP_INSECURE=true
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4318
    volumes:
      # supporting self-signed certificates, easiest way >>>>
      - ./certs/ca-certificates.crt:/etc/ssl/certs/ca-certificates.crt:ro
      # supporting self-signed certificates, easiest way <<<<
      - bgs:/data/bigsky
    restart: always
    depends_on:
      - database
      - caddy

  bsky:
    # appview(api)
    image: ${BRANDED_NAMESPACE}/${REBRANDING_NAME:-bluesky}-atproto-bsky:${branded_asof}
    profiles: ['', 'atproto']
    build:
      context: ./repos/atproto/
      dockerfile: services/bsky/Dockerfile
      args:
       - http_proxy=${http_proxy}
       - https_proxy=${https_proxy}
       - no_proxy=${no_proxy}
       - JAVA_TOOL_OPTIONS=${JAVA_TOOL_OPTIONS}
    ports:
      - 2584:2584
    expose:
      - 2584
    command: node --enable-source-maps api.js
    # to fix permision mismatch between volume owner(root) and process user(uid:1000, i.e: node), run as root. >>>>
    user: root
    # to fix permision mismatch between volume owner(root) and process user(uid:1000, i.e: node), run as root. <<<<
    environment:
      - BSKY_ADMIN_PASSWORDS=${BSKY_ADMIN_PASSWORDS}
      - BSKY_BLOB_CACHE_LOC=/cache/
      - BSKY_BSYNC_HTTP_VERSION=1.1
      - BSKY_BSYNC_PORT=3002
      - BSKY_BSYNC_URL=http://bsky:3002
      - BSKY_COURIER_URL=http://fake-courier.example.invalid/
      - BSKY_DATAPLANE_HTTP_VERSION=1.1
      - BSKY_DATAPLANE_PORT=3001
      - BSKY_DATAPLANE_URLS=http://bsky:3001
      - BSKY_DB_POSTGRES_SCHEMA=bsky
      - BSKY_DB_POSTGRES_URL=postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@database/bsky
      - BSKY_DID_PLC_URL=https://${plcFQDN}
      - BSKY_LABELS_FROM_ISSUER_DIDS=${BSKY_LABELS_FROM_ISSUER_DIDS}
      - BSKY_PUBLIC_URL=https://${bskyFQDN}
      - BSKY_REPO_PROVIDER=wss://${bgsFQDN}
      - BSKY_SEARCH_URL=https://${palomarFQDN}
      - BSKY_SERVER_DID=did:web:${bskyFQDN}
      - BSKY_SERVICE_SIGNING_KEY=${BSKY_SERVICE_SIGNING_KEY}
      - BSKY_STATSIG_KEY=${BSKY_STATSIG_KEY}
      - BSKY_STATSIG_ENV=${BSKY_STATSIG_ENV}
      - DEBUG_MODE=1
      - DID_PLC_URL=https://${plcFQDN}
      - ENABLE_MIGRATIONS=false
      - GOINSECURE=${GOINSECURE}
      - LOG_DESTINATION=1
      - LOG_ENABLED=true
      - LOG_LEVEL=${LOG_LEVEL_DEFAULT}
      - MOD_SERVICE_DID=did:web:${ozoneFQDN}
      - NODE_ENV=development
      - NODE_TLS_REJECT_UNAUTHORIZED=${NODE_TLS_REJECT_UNAUTHORIZED}
      - PORT=2584
      - REDIS_HOST=redis
      # telemetry settings
      - DD_TRACE_AGENT_URL=http://otel-collector:8126
      - DD_TRACE_PROPAGATION_STYLE=tracecontext,baggage
      - DD_TRACE_128_BIT_TRACEID_LOGGING_ENABLED=true
    volumes:
      # supporting self-signed certificates, easiest way >>>>
      - ./certs/ca-certificates.crt:/etc/ssl/certs/ca-certificates.crt:ro
      # supporting self-signed certificates, easiest way <<<<
      - bsky:/cache/
#     - ./repos/atproto/services/bsky/api.js:/app/services/bsky/api.js:ro
    restart: always
    depends_on:
      - database
      - redis
      - caddy

  social-app:
    # image: ${UNBRANDED_NAMESPACE}/bluesky-social-app:${asof}
    image: ${BRANDED_NAMESPACE}/${REBRANDING_NAME:-bluesky}-social-app:${branded_asof}-${DOMAIN}
    # the social-app Dockerfile compiles for this platform
    platform: linux/amd64
    profiles: ['', 'social-app']
    build:
      context: ./repos/social-app/
      dockerfile: Dockerfile
      args:
       - http_proxy=${http_proxy}
       - https_proxy=${https_proxy}
       - no_proxy=${no_proxy}
       - JAVA_TOOL_OPTIONS=${JAVA_TOOL_OPTIONS}
       - SENTRY_ORG=${SENTRY_ORG}
       - SENTRY_PROJECT=${SENTRY_PROJECT}
       - SENTRY_ENVIRONMENT=${SENTRY_ENVIRONMENT}
       - EXPO_PUBLIC_SENTRY_DSN=${EXPO_PUBLIC_SENTRY_DSN}
       - EXPO_PUBLIC_STATSIG_CLIENT_KEY=${EXPO_PUBLIC_STATSIG_CLIENT_KEY}
       - EXPO_PUBLIC_STATSIG_API_URL=${EXPO_PUBLIC_STATSIG_API_URL}
    ports:
      - 8100:8100
    command: /bin/sh -c "/usr/bin/$${REBRANDED_WEB_SERVICE:-bskyweb} serve"
    volumes:
      # supporting self-signed certificates, easiest way >>>>
      - ./certs/ca-certificates.crt:/etc/ssl/certs/ca-certificates.crt:ro
      # supporting self-signed certificates, easiest way <<<<
    environment:
      # cf. https://github.com/bluesky-social/social-app/blob/main/bskyweb/example.env and https://github.com/bluesky-social/bsky-docs/issues/63 >>>>
      - ATP_APPVIEW_HOST=https://${publicApiFQDN}
      # cf. https://github.com/bluesky-social/social-app/blob/main/bskyweb/example.env and https://github.com/bluesky-social/bsky-docs/issues/63 <<<<
      - GOINSECURE=${GOINSECURE}
      - GOLOG_LOG_LEVEL=${LOG_LEVEL_DEFAULT}
      - HTTP_ADDRESS=:8100
      - LOG_LEVEL=${LOG_LEVEL_DEFAULT}
      - NODE_ENV=development
      - NODE_TLS_REJECT_UNAUTHORIZED=${NODE_TLS_REJECT_UNAUTHORIZED}
      - REBRANDED_WEB_SERVICE=${REBRANDED_WEB_SERVICE:-bskyweb}
      - SENTRY_AUTH_TOKEN=${SENTRY_AUTH_TOKEN}
      - IPCC_HOST=http://ipcc:8080
    healthcheck:
      test: ["CMD-SHELL", "curl http://localhost:8100 | grep 'API docs at https://atproto.com' >/dev/null"]
      timeout: 10s
      interval: 10s
      retries: 5
    restart: always

  palomar:
    image: ${BRANDED_NAMESPACE}/${REBRANDING_NAME:-bluesky}-indigo-palomar:${branded_asof}
    profiles: ['', 'indigo']
    build:
      context: ./repos/indigo/
      dockerfile: cmd/palomar/Dockerfile
      args:
       - http_proxy=${http_proxy}
       - https_proxy=${https_proxy}
       - no_proxy=${no_proxy}
       - JAVA_TOOL_OPTIONS=${JAVA_TOOL_OPTIONS}
    ports:
      - 3999:3999
      # - 3998:3998 # metrics port by default
    volumes:
      # supporting self-signed certificates, easiest way >>>>
      - ./certs/ca-certificates.crt:/etc/ssl/certs/ca-certificates.crt:ro
      # supporting self-signed certificates, easiest way <<<<
    environment:
      # refer https://github.com/bluesky-social/indigo/tree/main/cmd/palomar
      - ATP_BGS_HOST=wss://${bgsFQDN}
      - ATP_PLC_HOST=https://${plcFQDN}
      - DATABASE_URL=postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@database/palomar
#     - ES_CERT_FILE=
      - OPENSEARCH_INITIAL_ADMIN_PASSWORD=${OPENSEARCH_INITIAL_ADMIN_PASSWORD}
      - ES_HOSTS=http://admin:${OPENSEARCH_INITIAL_ADMIN_PASSWORD}@opensearch:9200
      - ES_INSECURE_SSL=true
      - ES_PASSWORD=
      - ES_USERNAME=
      - GOINSECURE=${GOINSECURE}
      - NODE_TLS_REJECT_UNAUTHORIZED=${NODE_TLS_REJECT_UNAUTHORIZED}
      - PALOMAR_BIND=0.0.0.0:3999
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4318
    restart: always
    depends_on:
      - opensearch
      - database
      - caddy

  jetstream:
    # image: ${UNBRANDED_NAMESPACE}/bluesky-jetstream:${asof}
    image: ${UNBRANDED_NAMESPACE}/bluesky-jetstream:latest
    profiles: ['', 'jetstream']
    build:
      context: ./repos/jetstream/
      dockerfile: Dockerfile
      args:
       - http_proxy=${http_proxy}
       - https_proxy=${https_proxy}
       - no_proxy=${no_proxy}
       - JAVA_TOOL_OPTIONS=${JAVA_TOOL_OPTIONS}
    ports:
      - 6008:6008
      # - 6009:6009 metrics address
    volumes:
      - jetstream:/data
      # supporting self-signed certificates, easiest way >>>>
      - ./certs/ca-certificates.crt:/etc/ssl/certs/ca-certificates.crt:ro
      # supporting self-signed certificates, easiest way <<<<
    environment:
      - JETSTREAM_WS_URL=wss://${bgsFQDN}/xrpc/com.atproto.sync.subscribeRepos
      - JETSTREAM_DATA_DIR=/data
      - JETSTREAM_LISTEN_ADDR=:6008
      - JETSTREAM_METRICS_LISTEN_ADDR=:6009
      - JETSTREAM_LIVENESS_TTL=96h
    restart: always
    depends_on:
      - caddy

  ozone-standalone:
    # moderation-api:
    image: ${UNBRANDED_NAMESPACE}/bluesky-ozone:latest
    profiles: ['', 'ozone']
    build:
      context: ./repos/ozone/
      dockerfile: Dockerfile
      args:
       - http_proxy=${http_proxy}
       - https_proxy=${https_proxy}
       - no_proxy=${no_proxy}
       - JAVA_TOOL_OPTIONS=${JAVA_TOOL_OPTIONS}
    ports:
      - 3000:3000
    volumes:
      # supporting self-signed certificates, easiest way >>>>
      - ./certs/ca-certificates.crt:/etc/ssl/certs/ca-certificates.crt:ro
      # supporting self-signed certificates, easiest way <<<<
#     - ./repos/atproto/services/ozone/api.js:/app/services/ozone/api.js:ro
    environment:
#     https://github.com/bluesky-social/ozone/blob/main/HOSTING.md
      - LOG_ENABLED=1
      - DEBUG_MODE=1
      - LOG_DESTINATION=1
      - LOG_LEVEL=${LOG_LEVEL_DEFAULT}
#     - NODE_ENV=development
      - NODE_ENV=production
      - NODE_TLS_REJECT_UNAUTHORIZED=${NODE_TLS_REJECT_UNAUTHORIZED}
      - GOINSECURE=${GOINSECURE}
      - OZONE_DEV_MODE=true
      - OZONE_PORT=3000
      - OZONE_SERVER_DID=${OZONE_SERVER_DID}
      - OZONE_PUBLIC_URL=https://${ozoneFQDN}
      - OZONE_ADMIN_HANDLE=${OZONE_ADMIN_HANDLE}
      - OZONE_ADMIN_DIDS=${OZONE_ADMIN_DIDS}
      - OZONE_ADMIN_PASSWORD=${OZONE_ADMIN_PASSWORD}
      - OZONE_SIGNING_KEY_HEX=${OZONE_SIGNING_KEY_HEX}
      - OZONE_DB_POSTGRES_URL=postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@database/ozone
      - OZONE_DB_POSTGRES_SCHEMA=ozone
      - OZONE_DB_MIGRATE=1
      - OZONE_DID_PLC_URL=https://${plcFQDN}
      - NEXT_PUBLIC_PLC_DIRECTORY_URL=https://${plcFQDN}
      - NEXT_PUBLIC_OZONE_SERVICE_DID=${OZONE_SERVER_DID}
      - NEXT_PUBLIC_OZONE_PUBLIC_URL=https://${ozoneFQDN}
      - NEXT_PUBLIC_SOCIAL_APP_DOMAIN=${socialappFQDN}
      - NEXT_PUBLIC_SOCIAL_APP_URL=https://${socialappFQDN}
      - NEXT_PUBLIC_HANDLE_RESOLVER_URL=https://${publicApiFQDN}
      - OZONE_APPVIEW_DID=did:web:${bskyFQDN}
      - OZONE_APPVIEW_URL=https://${bskyFQDN}
      - OZONE_APPVIEW_PUSH_EVENTS=true
      - OZONE_PDS_DID=did:web:${pdsFQDN}
      - OZONE_PDS_URL=https://${pdsFQDN}
    restart: always
    depends_on:
      - database
      - caddy

  ozone:
    # moderation-api:
    image: ${UNBRANDED_NAMESPACE}/bluesky-atproto-ozone:${asof}
    profiles: ['', 'atproto']
    build:
      context: ./repos/atproto/
      dockerfile: services/ozone/Dockerfile
      args:
       - http_proxy=${http_proxy}
       - https_proxy=${https_proxy}
       - no_proxy=${no_proxy}
       - JAVA_TOOL_OPTIONS=${JAVA_TOOL_OPTIONS}
    command: node --enable-source-maps api.js
    ports:
      - 3000:3000
    volumes:
      # supporting self-signed certificates, easiest way >>>>
      - ./certs/ca-certificates.crt:/etc/ssl/certs/ca-certificates.crt:ro
      # supporting self-signed certificates, easiest way <<<<
#     - ./repos/atproto/services/ozone/api.js:/app/services/ozone/api.js:ro
    environment:
      - DEBUG_MODE=1
      - ENABLE_MIGRATIONS=true
      - GOINSECURE=${GOINSECURE}
      - LOG_DESTINATION=1
      - LOG_ENABLED=true
      - LOG_LEVEL=${LOG_LEVEL_DEFAULT}
      - NODE_ENV=development
      - NODE_TLS_REJECT_UNAUTHORIZED=${NODE_TLS_REJECT_UNAUTHORIZED}
      - OZONE_ADMIN_DIDS=
      - OZONE_ADMIN_PASSWORD=${OZONE_ADMIN_PASSWORD}
      - OZONE_APPVIEW_DID=did:web:${bskyFQDN}
      - OZONE_APPVIEW_PUSH_EVENTS=true
      - OZONE_APPVIEW_URL=https://${bskyFQDN}
      - OZONE_DB_POSTGRES_SCHEMA=ozone
      - OZONE_DB_POSTGRES_URL=postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@database/ozone
      - OZONE_DEV_MODE=true
      - OZONE_DID_PLC_URL=https://${plcFQDN}
      - OZONE_MODERATOR_DIDS=did:web:${bskyFQDN}
      - OZONE_PDS_DID=did:web:${pdsFQDN}
      - OZONE_PDS_URL=https://${pdsFQDN}
      - OZONE_PORT=3000
      - OZONE_PUBLIC_URL=https://${ozoneFQDN}
      - OZONE_SERVER_DID=did:web:${ozoneFQDN}
      - OZONE_SIGNING_KEY_HEX=${OZONE_SIGNING_KEY_HEX}
      - OZONE_TRIAGE_DIDS=
    restart: always
    depends_on:
      - database
      - caddy

  ozone-daemon:
    image: ${UNBRANDED_NAMESPACE}/bluesky-atproto-ozone:${asof}
    profiles: ['', 'atproto']
    build:
      context: ./repos/atproto/
      dockerfile: services/ozone/Dockerfile
      args:
       - http_proxy=${http_proxy}
       - https_proxy=${https_proxy}
       - no_proxy=${no_proxy}
       - JAVA_TOOL_OPTIONS=${JAVA_TOOL_OPTIONS}
    command: node --enable-source-maps daemon.js
    volumes:
      # supporting self-signed certificates, easiest way >>>>
      - ./certs/ca-certificates.crt:/etc/ssl/certs/ca-certificates.crt:ro
      # supporting self-signed certificates, easiest way <<<<
    environment:
      - DEBUG_MODE=1
      - ENABLE_MIGRATIONS=true
      - GOINSECURE=${GOINSECURE}
      - LOG_DESTINATION=1
      - LOG_ENABLED=true
      - LOG_LEVEL=${LOG_LEVEL_DEFAULT}
      - NODE_ENV=development
      - NODE_TLS_REJECT_UNAUTHORIZED=${NODE_TLS_REJECT_UNAUTHORIZED}
      - OZONE_ADMIN_DIDS=
      - OZONE_ADMIN_PASSWORD=${OZONE_ADMIN_PASSWORD}
      - OZONE_APPVIEW_DID=did:web:${bskyFQDN}
      - OZONE_APPVIEW_PUSH_EVENTS=true
      - OZONE_APPVIEW_URL=https://${bskyFQDN}
      - OZONE_DB_POSTGRES_SCHEMA=ozone
      - OZONE_DB_POSTGRES_URL=postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@database/ozone
      - OZONE_DEV_MODE=true
      - OZONE_DID_PLC_URL=https://${plcFQDN}
      - OZONE_MODERATOR_DIDS=did:web:${bskyFQDN}
      - OZONE_PDS_DID=did:web:${pdsFQDN}
      - OZONE_PDS_URL=https://${pdsFQDN}
      - OZONE_PORT=3000
      - OZONE_PUBLIC_URL=https://${ozoneFQDN}
      - OZONE_SERVER_DID=did:web:${ozoneFQDN}
      - OZONE_SIGNING_KEY_HEX=${OZONE_SIGNING_KEY_HEX}
      - OZONE_TRIAGE_DIDS=
    restart: always
    depends_on:
      - ozone
      - database
      - caddy

  feed-generator:
    # image: ${UNBRANDED_NAMESPACE}/bluesky-feed-generator:${asof}
    image: ${UNBRANDED_NAMESPACE}/bluesky-feed-generator:latest
    profiles: ['', 'feed-generator']
    build:
      context: ./repos/feed-generator/
      dockerfile: Dockerfile
      args:
       - http_proxy=${http_proxy}
       - https_proxy=${https_proxy}
       - no_proxy=${no_proxy}
       - JAVA_TOOL_OPTIONS=${JAVA_TOOL_OPTIONS}
    ports:
      - 2586:3000
    environment:
      - FEEDGEN_HOSTNAME=${feedgenFQDN}
      - FEEDGEN_LISTENHOST=0.0.0.0
      - FEEDGEN_PORT=3000
      - FEEDGEN_PUBLISHER_DID=${FEEDGEN_PUBLISHER_DID}
      - FEEDGEN_SERVICE_DID=did:web:${feedgenFQDN}
      - FEEDGEN_SQLITE_LOCATION=/data/db.sqlite
      - FEEDGEN_PLC_URL=https://${plcFQDN}
      - FEEDGEN_SUBSCRIPTION_ENDPOINT=wss://${bgsFQDN}
      - FEEDGEN_SUBSCRIPTION_RECONNECT_DELAY=3000
      - GOINSECURE=${GOINSECURE}
      - NODE_ENV=development
      - NODE_TLS_REJECT_UNAUTHORIZED=${NODE_TLS_REJECT_UNAUTHORIZED}
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "curl -s http://localhost:3000/xrpc/_health"]
      timeout: 10s
      interval: 10s
      retries: 5
    volumes:
      # supporting self-signed certificates, easiest way >>>>
      - ./certs/ca-certificates.crt:/etc/ssl/certs/ca-certificates.crt:ro
      # supporting self-signed certificates, easiest way <<<<
      - feed-generator:/data/
#     - ${rDir}/feed-generator:/app

  ipcc:
    image: davidfinconceivableza/ip-location-service-bsky
    volumes:
      # persist ip location data
      - ipcc:/app/downloads
    environment:
      - DB_TYPE=mmdb
      - COUNTRY=geo-whois-asn-country
      - ASN=
    restart: always

  backup:
    image: creativeprojects/resticprofile:0.29.0 # wait until restic issue #5324 fix is released before upgrading
    hostname: backup.${HOST_HOSTNAME:-${DOMAIN}}
    volumes:
      - ./ops-helper/backup-scripts:/scripts:ro
      - ./config/backup/:/etc/resticprofile/:ro
      - ./data/accounts/backup-credentials:/resticprofile/credentials/remote:ro
      - pds:/data/pds:rw
      - feed-generator:/data/feed-generator:rw
      - opensearch:/data/opensearch:rw
      - bgs:/data/bgs:rw
      - bsky:/data/bsky:rw
      - backup-staging:/staging
      - backup-repo:/restic-repo
    environment:
      - TZ=Etc/UTC
      - BACKUP_PATHS=/data/pds/blobs/ /data/bgs/ /data/bsky/ /data/opensearch/
      - SQLITE_PATHS=sqlite/pds:/data/pds/*.sqlite sqlite/feed-generator:/data/feed-generator/*.sqlite  # Glob pattern for SQLite files
      - PGHOST=database
      - PGPORT=5432
      - PGUSER=${POSTGRES_USER}
      - PGPASSWORD=${POSTGRES_PASSWORD}
      - RESTIC_REPOSITORY=/restic-repo
      # if RESTIC_REMOTE_REPO#N and RESTIC_REMOTE_PASSWORD#N defined, these repos will be initialized and copied to automatically. N=1,2,3
      - RESTIC_PASSWORD=${RESTIC_PASSWORD}
      - RESTIC_PASSWORD_FILE=/resticprofile/credentials/local-password
      - RESTIC_REMOTE_REPO1=${RESTIC_REMOTE_REPO1}
      - RESTIC_REMOTE_REPO2=${RESTIC_REMOTE_REPO2}
      - RESTIC_REMOTE_REPO3=${RESTIC_REMOTE_REPO3}
      - RESTIC_REMOTE_PASSWORD1=${RESTIC_REMOTE_PASSWORD1}
      - RESTIC_REMOTE_PASSWORD2=${RESTIC_REMOTE_PASSWORD2}
      - RESTIC_REMOTE_PASSWORD3=${RESTIC_REMOTE_PASSWORD3}
      - RESTIC_LOGDIR=/var/log
      # if any of these keys are needed for the remote storage services, they can be configured in the environment
      - AWS_ACCESS_KEY_ID=${RESTIC_AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${RESTIC_AWS_SECRET_ACCESS_KEY}
      - GOOGLE_PROJECT_ID=${RESTIC_GOOGLE_PROJECT_ID}
      - GOOGLE_APPLICATION_CREDENTIALS=/resticprofile/credentials/remote/${RESTIC_GOOGLE_APPLICATION_CREDENTIALS}
    entrypoint: ["/bin/sh"]
    command: ['-c', '/scripts/entrypoint.sh && resticprofile schedule --all && crond -f']
    restart: always

  jaeger:
    image: jaegertracing/all-in-one:latest
    volumes:
      - "./config/telemetry/jaeger-ui.json:/etc/jaeger/jaeger-ui.json"
    command: --query.ui-config /etc/jaeger/jaeger-ui.json
    environment:
      - COLLECTOR_OTLP_ENABLED=true
      - METRICS_STORAGE_TYPE=prometheus
      - PROMETHEUS_SERVER_URL=http://prometheus:9090
    ports:
      # don't expose telemetry to public networks; other containers can connect directly, but expose the web interface on localhost
      # - "14250:14250"   # legacy jaeger-agent spans gRPC protobuf
      # - "14268:14268"   # legacy thrift_http receiver and sampling
      - "127.0.0.1:14269:14269"   # admin port: health check at / and metrics at /metrics
      # - "4317:4317"     # otlp collector over gRPC
      # - "4318:4318"     # otlp collector over http
      # - "6831:6831/udp" # legacy thrift in compact thrift protocol
      # - "6832:6832/udp" # legacy thrift in binary thrift protocol
      # - "9411:9411"     # zipkin v1 JSON or Thrift, v2 JSON or protobuf
      - "127.0.0.1:16686:16686"   # Jaeger UI
      # - "16685:16685"   # otlp-based protobuf, legacy protobuf read

  otel-collector:
    image: otel/opentelemetry-collector-contrib:latest
    volumes:
      - "./config/telemetry/otel-collector-config.yml:/etc/otelcol/otel-collector-config.yml"
    command:
      - "--config=/etc/otelcol/otel-collector-config.yml"
      - "--feature-gates=receiver.datadogreceiver.Enable128BitTraceID"
    ports:
      # don't expose telemetry to public networks; other containers can connect directly, but expose the web interface on localhost
      # - "4317:4317"   # OTLP gRPC receiver
      # - "4318:4318"   # OTLP HTTP receiver
      # - "8888:8888"   # Prometheus metrics
      # - "8889:8889"   # Prometheus exporter metrics
      # - "13133:13133" # health_check extension
      - "127.0.0.1:55679:55679" # ZPages for direct view
      # - "14268:14268" # default jaeger thrift_http receiver, but jaeger listens there
      # - "14278:14278" # alternate jaeger thrift_http receiver
      # - "8126:8126"   # datadog receiver for services instrumented with ddtrace
    depends_on:
      - jaeger
      - prometheus

  prometheus:
    image: prom/prometheus:latest
    volumes:
      - "./config/telemetry/prometheus.yml:/etc/prometheus/prometheus.yml"
      # - "./data/prometheus:/prometheus"
    ports:
      # don't expose telemetry to public networks; other containers can connect directly, but expose the web interface on localhost
      - "127.0.0.1:9090:9090"
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      # - "--storage.tsdb.path=/prometheus"
      - "--storage.tsdb.retention.time=200h"

